name: backend-build
description: Build backend

inputs:
  variables-env:
    description: Variables in .env file
    required: true
  ssh-username:
    description: Username for SSH connection
    required: true
  ssh-host:
    description: Host for SSH connection
    required: true

runs:
  using: composite
  steps:
    - name: Copy .env files and backend code to host
      shell: bash
      run: |
        echo "${{ inputs.variables-env }}" > .production.env
        echo "${{ inputs.variables-env }}" > .development.env
        echo "${{ inputs.variables-env }}" > .env
        scp .production.env ${{ inputs.ssh-username }}@${{ inputs.ssh-host }}:/home/linkedout-noventiq/linkedout/backend
        scp .development.env ${{ inputs.ssh-username }}@${{ inputs.ssh-host }}:/home/linkedout-noventiq/linkedout/backend
        scp .env ${{ inputs.ssh-username }}@${{ inputs.ssh-host }}:/home/linkedout-noventiq/linkedout/backend

    - name: Install dependencies, build, and start the backend on the VM
      shell: bash
      run: |
        ssh ${{ inputs.ssh-username }}@${{ inputs.ssh-host }} << EOF
          cd /home/linkedout-noventiq/linkedout/backend
          npm install
          pm2 list | grep backend && pm2 restart backend || pm2 start npm --name backend -- start
          sudo systemctl reload nginx
          sudo nginx -t
        EOF
